<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSA A-Star / PA-Star</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="container">
        <header>
            <h1><svg class="icon icon-header" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9.75 3.104v5.714a2.25 2.25 0 0 1-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 0 1 4.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0 1 12 15a9.065 9.065 0 0 0-6.23.693L5 14.5m14.8.8 1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0 1 12 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5" />
                </svg> MSA A-Star / PA-Star</h1>
            <p class="subtitle">Multiple Sequence Alignment</p>
        </header>

        <div class="main-content">
            <!-- Configuration Panel -->
            <div class="config-panel">
                <h2><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    </svg> Configuração</h2>

                <div class="form-group">
                    <label for="algorithm">Algoritmo:</label>
                    <select id="algorithm" class="form-control">
                        <option value="msa_astar">MSA A-Star (Serial)</option>
                        <option value="msa_pastar" selected>MSA PA-Star (Paralelo)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="binary_version">Versão do Binário:</label>
                    <select id="binary_version" class="form-control">
                        <option value="">-- Carregando versões... --</option>
                    </select>
                </div>

                <div class="form-group" id="threads-group">
                    <label for="num_threads">Número de Threads:</label>
                    <input type="number" id="num_threads" class="form-control" value="4" min="1" max="128">
                </div>

                <div class="form-group">
                    <label for="cost_type">Tipo de Matriz:</label>
                    <select id="cost_type" class="form-control">
                        <option value="PAM250" selected>PAM250 (Proteínas)</option>
                        <option value="NUC">NUC (Nucleotídeos)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label
                        title="Ativa o modo verbose (flag -l), que gera um arquivo de log com TODOS os NÓS expandidos detalhadamente. Essa opção pode aumentar significativamente o tempo de execução e o tamanho do arquivo de log. Use com cautela em grandes conjuntos de dados. Recomendado apenas para depuração ou análise detalhada. Desenvolvido para ser usado com PA-Star Runtime Visualizer">
                        <input type="checkbox" id="verbose_mode" value="1">
                        Modo Verbose <svg class="icon icon-small" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
                        </svg>
                    </label>
                </div>

                <h3><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" />
                    </svg> Sequências</h3>

                <div class="form-group">
                    <label for="source">Fonte:</label>
                    <select id="source" class="form-control">
                        <option value="">-- Selecione uma fonte --</option>
                        {% for source_key, source_data in all_sequences.items() %}
                        <option value="{{ source_key }}">{{ source_data.name }} - {{ source_data.description }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="category">Categoria:</label>
                    <select id="category" class="form-control" disabled>
                        <option value="">-- Primeiro selecione uma fonte --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="subcategory">Subcategoria:</label>
                    <select id="subcategory" class="form-control" disabled>
                        <option value="">-- Selecione se houver subcategorias --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sequence_file">Arquivo de Sequência:</label>
                    <select id="sequence_file" class="form-control" disabled>
                        <option value="">-- Selecione uma categoria primeiro --</option>
                    </select>
                </div>

                <button id="btn-info" class="btn btn-secondary" disabled>
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                    </svg> Ver Informações da Sequência
                </button>

                <button id="btn-run" class="btn btn-primary" disabled>
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
                    </svg> Executar Alinhamento
                </button>
            </div>

            <!-- Results Panel -->
            <div class="results-panel">
                <h2><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                    </svg> Resultados</h2>

                <div id="sequence-info" class="info-box" style="display: none;">
                    <h3>Informações da Sequência</h3>
                    <div id="sequence-info-content"></div>
                </div>

                <div id="execution-status" class="status-box" style="display: none;">
                    <h3>Status da Execução</h3>
                    <div id="execution-status-content"></div>
                </div>

                <div id="results-content" style="display: none;">
                    <h3>Resultado do Alinhamento</h3>
                    <div class="result-stats" id="result-stats"></div>
                    <div class="result-output">
                        <h4>Saída (FASTA):</h4>
                        <button id="btn-download" class="btn btn-secondary"><svg class="icon"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                            </svg> Download FASTA</button>
                        <pre id="output-content"></pre>
                    </div>
                    <div class="result-logs">
                        <h4>Log da Execução:</h4>
                        <pre id="log-content"></pre>
                    </div>
                    <div class="result-logs" id="verbose-logs-section" style="display: none;">
                        <h4>Log Verbose (-l):</h4>
                        <pre id="verbose-log-content"></pre>
                    </div>
                </div>

                <div id="history-section">
                    <h3><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg> Histórico de Execuções</h3>
                    <div id="history-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        const sequencesData = {{ all_sequences | tojson }};
        let availableBinaries = { astar: [], pastar: [] };
        let currentResultId = null;
        let currentFilePath = null;

        // Elements
        const algorithmSelect = document.getElementById('algorithm');
        const binaryVersionSelect = document.getElementById('binary_version');
        const threadsGroup = document.getElementById('threads-group');
        const sourceSelect = document.getElementById('source');
        const categorySelect = document.getElementById('category');
        const subcategorySelect = document.getElementById('subcategory');
        const sequenceFileSelect = document.getElementById('sequence_file');
        const btnInfo = document.getElementById('btn-info');
        const btnRun = document.getElementById('btn-run');
        const btnDownload = document.getElementById('btn-download');

        // Load available binaries
        async function loadBinaries() {
            try {
                const response = await fetch('/api/binaries');
                availableBinaries = await response.json();
                updateBinaryVersions();
            } catch (error) {
                console.error('Error loading binaries:', error);
                binaryVersionSelect.innerHTML = '<option value="">Erro ao carregar versões</option>';
            }
        }

        // Update binary versions dropdown based on selected algorithm
        function updateBinaryVersions() {
            const algorithm = algorithmSelect.value;
            const binaries = algorithm === 'msa_astar' ? availableBinaries.astar : availableBinaries.pastar;

            binaryVersionSelect.innerHTML = '';

            if (binaries.length === 0) {
                binaryVersionSelect.innerHTML = '<option value="">Nenhuma versão disponível</option>';
                binaryVersionSelect.disabled = true;
                return;
            }

            binaries.forEach((binary, index) => {
                const option = document.createElement('option');
                option.value = binary.name;
                option.textContent = binary.display_name;
                if (index === 0) option.selected = true;  // Select first by default
                binaryVersionSelect.appendChild(option);
            });

            binaryVersionSelect.disabled = false;
        }

        // Toggle threads input based on algorithm
        algorithmSelect.addEventListener('change', () => {
            threadsGroup.style.display =
                algorithmSelect.value === 'msa_pastar' ? 'block' : 'none';
            updateBinaryVersions();
        });

        // Load binaries on page load
        loadBinaries();

        // Helper function to check if an object has files
        function hasFiles(obj) {
            return obj && obj._files && obj._files.length > 0;
        }

        // Helper function to get nested structure
        function getNestedStructure(source, category, subcategory = null) {
            if (!sequencesData[source] || !sequencesData[source].categories) return null;

            const categories = sequencesData[source].categories;
            if (!categories[category]) return null;

            if (subcategory) {
                return categories[category][subcategory] || null;
            }

            return categories[category];
        }

        // Source selection
        sourceSelect.addEventListener('change', () => {
            const source = sourceSelect.value;
            categorySelect.innerHTML = '<option value="">-- Selecione uma categoria --</option>';
            subcategorySelect.innerHTML = '<option value="">-- Selecione se houver subcategorias --</option>';
            sequenceFileSelect.innerHTML = '<option value="">-- Selecione uma categoria primeiro --</option>';

            categorySelect.disabled = true;
            subcategorySelect.disabled = true;
            sequenceFileSelect.disabled = true;

            if (source && sequencesData[source] && sequencesData[source].categories) {
                const categories = sequencesData[source].categories;
                const catKeys = Object.keys(categories).filter(k => k !== '_files');

                if (catKeys.length > 0) {
                    catKeys.forEach(catKey => {
                        const option = document.createElement('option');
                        option.value = catKey;
                        option.textContent = catKey;
                        categorySelect.appendChild(option);
                    });
                    categorySelect.disabled = false;
                }

                // Check if there are files directly in the source
                if (hasFiles(categories)) {
                    categorySelect.innerHTML = '<option value="_root">Arquivos na raiz</option>';
                    categorySelect.disabled = false;
                }
            }

            updateButtonStates();
        });

        // Category selection
        categorySelect.addEventListener('change', () => {
            const source = sourceSelect.value;
            const category = categorySelect.value;

            subcategorySelect.innerHTML = '<option value="">-- Selecione se houver subcategorias --</option>';
            sequenceFileSelect.innerHTML = '<option value="">-- Selecione uma categoria primeiro --</option>';
            subcategorySelect.disabled = true;
            sequenceFileSelect.disabled = true;

            if (!source || !category) {
                updateButtonStates();
                return;
            }

            const catData = getNestedStructure(source, category);

            if (!catData) {
                updateButtonStates();
                return;
            }

            // Check for subcategories
            const subcatKeys = Object.keys(catData).filter(k => k !== '_files' && typeof catData[k] === 'object');

            if (subcatKeys.length > 0) {
                subcatKeys.forEach(subcatKey => {
                    const option = document.createElement('option');
                    option.value = subcatKey;
                    option.textContent = subcatKey;
                    subcategorySelect.appendChild(option);
                });
                subcategorySelect.disabled = false;
            }

            // Check for files directly in category
            if (hasFiles(catData)) {
                populateFiles(catData._files, source, category, null);
            }

            updateButtonStates();
        });

        // Subcategory selection
        subcategorySelect.addEventListener('change', () => {
            const source = sourceSelect.value;
            const category = categorySelect.value;
            const subcategory = subcategorySelect.value;

            sequenceFileSelect.innerHTML = '<option value="">-- Selecione um arquivo --</option>';
            sequenceFileSelect.disabled = true;

            if (!subcategory) {
                // If subcategory is cleared, show category files
                const catData = getNestedStructure(source, category);
                if (hasFiles(catData)) {
                    populateFiles(catData._files, source, category, null);
                }
                updateButtonStates();
                return;
            }

            const subcatData = getNestedStructure(source, category, subcategory);

            if (subcatData && hasFiles(subcatData)) {
                populateFiles(subcatData._files, source, category, subcategory);
            }

            updateButtonStates();
        });

        // File selection
        sequenceFileSelect.addEventListener('change', () => {
            const selectedOption = sequenceFileSelect.selectedOptions[0];
            if (selectedOption) {
                currentFilePath = selectedOption.dataset.path;
            }
            updateButtonStates();
        });

        function populateFiles(files, source, category, subcategory) {
            sequenceFileSelect.innerHTML = '<option value="">-- Selecione um arquivo --</option>';

            const basePath = sequencesData[source].path + '/' + category;
            const fullPath = subcategory ? basePath + '/' + subcategory : basePath;

            files.forEach(file => {
                const option = document.createElement('option');
                option.value = file;
                option.textContent = file;
                option.dataset.path = fullPath + '/' + file;
                sequenceFileSelect.appendChild(option);
            });

            sequenceFileSelect.disabled = false;
        }

        function updateButtonStates() {
            const fileSelected = sequenceFileSelect.value !== '' && currentFilePath;
            btnInfo.disabled = !fileSelected;
            btnRun.disabled = !fileSelected;
        }

        // Show sequence information
        btnInfo.addEventListener('click', async () => {
            if (!currentFilePath) {
                alert('Selecione um arquivo primeiro');
                return;
            }

            try {
                const requestData = {
                    file_path: currentFilePath,
                    algorithm: algorithmSelect.value,
                    binary_name: binaryVersionSelect.value,
                    cost_type: document.getElementById('cost_type').value,
                    num_threads: parseInt(document.getElementById('num_threads').value),
                    verbose: document.getElementById('verbose_mode').checked
                };

                const response = await fetch('/api/sequence_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (response.ok) {
                    let html = `
                        <p><strong>Arquivo:</strong> ${data.file_path}</p>
                        <p><strong>Tipo de Sequência:</strong> ${data.sequence_type}</p>
                        <p><strong>Número de sequências:</strong> ${data.num_sequences}</p>
                    `;

                    // Show command if available
                    if (data.command) {
                        html += `
                            <div class="command-box">
                                <strong>Comando a ser executado:</strong>
                                <pre><code>${data.command}</code></pre>
                            </div>
                        `;
                    }

                    html += `
                        <table class="seq-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Header</th>
                                    <th>Comprimento</th>
                                    <th>Tipo</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.sequences.forEach((seq, idx) => {
                        html += `
                            <tr>
                                <td>${idx + 1}</td>
                                <td>${seq.header}</td>
                                <td>${seq.length}</td>
                                <td>${seq.type}</td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';

                    document.getElementById('sequence-info-content').innerHTML = html;
                    document.getElementById('sequence-info').style.display = 'block';
                } else {
                    alert('Erro ao obter informações: ' + data.error);
                }
            } catch (error) {
                alert('Erro ao obter informações: ' + error);
            }
        });

        // Run alignment
        btnRun.addEventListener('click', async () => {
            if (!currentFilePath) {
                alert('Selecione um arquivo primeiro');
                return;
            }

            const requestData = {
                algorithm: algorithmSelect.value,
                binary_name: binaryVersionSelect.value,  // Add selected binary version
                sequence_file: sequenceFileSelect.value,
                file_path: currentFilePath,
                cost_type: document.getElementById('cost_type').value,
                num_threads: parseInt(document.getElementById('num_threads').value),
                verbose: document.getElementById('verbose_mode').checked
            };

            // Show status
            document.getElementById('execution-status-content').innerHTML =
                '<p><svg class="icon icon-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" /></svg> Executando... Por favor aguarde.</p>';
            document.getElementById('execution-status').style.display = 'block';
            document.getElementById('results-content').style.display = 'none';

            btnRun.disabled = true;

            try {
                const response = await fetch('/api/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    currentResultId = data.result_id;

                    document.getElementById('execution-status-content').innerHTML =
                        `<p><svg class="icon icon-success" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Execução concluída com sucesso!</p>
                         <p><strong>Binário:</strong> ${data.binary}</p>
                         <p><strong>Tempo de execução:</strong> ${data.execution_time.toFixed(2)}s</p>`;

                    // Show results
                    document.getElementById('result-stats').innerHTML = `
                        <p><strong>ID:</strong> ${data.result_id}</p>
                        <p><strong>Binário:</strong> ${data.binary}</p>
                        <p><strong>Tempo:</strong> ${data.execution_time.toFixed(2)}s</p>
                        <p><strong>Código de retorno:</strong> ${data.return_code}</p>
                    `;

                    document.getElementById('output-content').textContent = data.output_content;
                    document.getElementById('log-content').textContent = data.stdout;

                    // Show verbose log if available
                    if (data.verbose && data.verbose_log_content) {
                        document.getElementById('verbose-log-content').textContent = data.verbose_log_content;
                        document.getElementById('verbose-logs-section').style.display = 'block';
                    } else {
                        document.getElementById('verbose-logs-section').style.display = 'none';
                    }

                    document.getElementById('results-content').style.display = 'block';

                    // Refresh history
                    loadHistory();
                } else {
                    document.getElementById('execution-status-content').innerHTML =
                        `<p><svg class="icon icon-error" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Erro na execução!</p>
                         <p>${data.error || 'Erro desconhecido'}</p>`;
                }
            } catch (error) {
                document.getElementById('execution-status-content').innerHTML =
                    `<p><svg class="icon icon-error" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Erro na execução!</p>
                     <p>${error}</p>`;
            } finally {
                btnRun.disabled = false;
            }
        });

        // Download result
        btnDownload.addEventListener('click', () => {
            if (currentResultId) {
                window.location.href = `/api/download/${currentResultId}`;
            }
        });

        // Sorting state for history
        let historySortColumn = null;
        let historySortDirection = 'desc'; // 'asc' or 'desc'
        let historyData = [];

        // Load execution history
        async function loadHistory() {
            try {
                const response = await fetch('/api/results');
                historyData = await response.json();

                renderHistory();
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Sort history data
        function sortHistory(column) {
            if (historySortColumn === column) {
                // Toggle direction if clicking same column
                historySortDirection = historySortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, default to descending
                historySortColumn = column;
                historySortDirection = 'desc';
            }

            renderHistory();
        }

        // Render history table
        function renderHistory() {
            if (historyData.length === 0) {
                document.getElementById('history-list').innerHTML =
                    '<p>Nenhuma execução anterior encontrada.</p>';
                return;
            }

            // Sort data if a column is selected
            let sortedData = [...historyData];
            if (historySortColumn) {
                sortedData.sort((a, b) => {
                    let valA, valB;

                    switch (historySortColumn) {
                        case 'id':
                            valA = a.id;
                            valB = b.id;
                            break;
                        case 'timestamp':
                            valA = a.timestamp || '';
                            valB = b.timestamp || '';
                            break;
                        case 'execution_time':
                            valA = a.execution_time || 0;
                            valB = b.execution_time || 0;
                            break;
                        case 'input_file':
                            valA = a.input_file || '';
                            valB = b.input_file || '';
                            break;
                        default:
                            return 0;
                    }

                    if (valA < valB) return historySortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return historySortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Build table HTML
            const getSortIndicator = (column) => {
                if (historySortColumn === column) {
                    return historySortDirection === 'asc' ? ' ▲' : ' ▼';
                }
                return '';
            };

            let html = '<table class="history-table"><thead><tr>' +
                `<th class="sortable" onclick="sortHistory('id')">ID${getSortIndicator('id')}</th>` +
                `<th class="sortable" onclick="sortHistory('input_file')">Arquivo${getSortIndicator('input_file')}</th>` +
                `<th class="sortable" onclick="sortHistory('timestamp')">Timestamp${getSortIndicator('timestamp')}</th>` +
                `<th class="sortable" onclick="sortHistory('execution_time')">Tempo (s)${getSortIndicator('execution_time')}</th>` +
                '<th>Status</th><th>Ação</th>' +
                '</tr></thead><tbody>';

            sortedData.forEach(result => {
                const status = result.return_code === 0 ? '<svg class="icon icon-success" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>' : '<svg class="icon icon-error" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>';
                const inputFile = result.input_file || 'N/A';
                html += `
                    <tr>
                        <td>${result.id}</td>
                        <td title="${inputFile}">${inputFile}</td>
                        <td>${result.timestamp}</td>
                        <td>${result.execution_time ? result.execution_time.toFixed(2) : 'N/A'}</td>
                        <td>${status}</td>
                        <td>
                            <button class="btn-small" onclick="loadResult('${result.id}')">Ver</button>
                            <button class="btn-small" onclick="downloadResult('${result.id}')" title="Download"><svg class="icon icon-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg></button>
                            <button class="btn-small btn-danger" onclick="deleteResult('${result.id}')" title="Excluir"><svg class="icon icon-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('history-list').innerHTML = html;
        }

        async function loadResult(resultId) {
            try {
                const response = await fetch(`/api/result/${resultId}`);
                const data = await response.json();

                if (response.ok) {
                    currentResultId = resultId;

                    document.getElementById('execution-status-content').innerHTML =
                        `<p><svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg> Resultado carregado do histórico</p>
                         <p><strong>Tempo de execução:</strong> ${data.execution_time.toFixed(2)}s</p>`;
                    document.getElementById('execution-status').style.display = 'block';

                    document.getElementById('result-stats').innerHTML = `
                        <p><strong>ID:</strong> ${resultId}</p>
                        <p><strong>Tempo:</strong> ${data.execution_time.toFixed(2)}s</p>
                        <p><strong>Código de retorno:</strong> ${data.return_code}</p>
                        <p><strong>Comando:</strong> <code>${data.command}</code></p>
                    `;

                    document.getElementById('output-content').textContent = data.output_content;
                    document.getElementById('log-content').textContent = data.stdout;

                    // Show verbose log if available
                    if (data.verbose && data.verbose_log_content) {
                        document.getElementById('verbose-log-content').textContent = data.verbose_log_content;
                        document.getElementById('verbose-logs-section').style.display = 'block';
                    } else {
                        document.getElementById('verbose-logs-section').style.display = 'none';
                    }

                    document.getElementById('results-content').style.display = 'block';
                }
            } catch (error) {
                alert('Erro ao carregar resultado: ' + error);
            }
        }

        function downloadResult(resultId) {
            window.location.href = `/api/download/${resultId}`;
        }

        async function deleteResult(resultId) {
            if (!confirm(`Tem certeza que deseja excluir o resultado "${resultId}"?\n\nEsta ação não pode ser desfeita.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/result/${resultId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Clear current result if it's the one being deleted
                    if (currentResultId === resultId) {
                        currentResultId = null;
                        document.getElementById('results-content').style.display = 'none';
                        document.getElementById('execution-status').style.display = 'none';
                    }
                    // Refresh history
                    loadHistory();
                } else {
                    alert('Erro ao excluir: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                alert('Erro ao excluir resultado: ' + error);
            }
        }

        // Load history on page load
        loadHistory();
    </script>
</body>

</html>